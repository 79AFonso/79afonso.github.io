<html>
<link type="text/css" rel="stylesheet" id="dark-mode-custom-link">
<link type="text/css" rel="stylesheet" id="dark-mode-general-link">
<style lang="en" type="text/css" id="dark-mode-custom-style"></style>
<style lang="en" type="text/css" id="dark-mode-native-style"></style>
<head>
    <title>Mapa da UA</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <link href="https://js.arcgis.com/4.14/esri/css/main.css" rel="stylesheet" type="text/css">
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-database.js"></script>
    <script type="text/javascript" src="https://js.arcgis.com/4.14/"></script>
    <style>
    html,
    body,
    #viewDiv {padding: 0;margin: 0;height: 98%;width: 100%;}
    </style>
    <script type="text/javascript">

    var locs_APS = [];
    var locs_Piso_1 = [];
    var locs_Piso_2 = [];
    var locs_Piso_3 = [];
    var locs_Piso_4 = [];
    var locs_Piso_5 = [];
    var list_index = [];

    require([
    "esri/Map",
    "esri/views/MapView",
    "esri/widgets/Home",
    "esri/layers/MapImageLayer",
    "esri/geometry/Extent",
    "esri/Graphic",
    "esri/layers/GraphicsLayer",
    "dojo/domReady!"
    ], function(Map, MapView, Home, MapImageLayer, Extent, Graphic, GraphicsLayer) {
        var uri = "https://sgt-websig.ua.pt/server/rest/services/Planta_Cobertura/MapServer";
        var res = encodeURI(uri); 

        var layer = new MapImageLayer({ url: res });
        var map = new Map({basemap: "dark-gray-vector", layers: [layer] });
        var view = new MapView({
            container: "viewDiv",
            zoom: 16,
            center: [-8.659132, 40.632902], //Longitude, latitude
            map: map
        });

        var firebaseConfig = {
        apiKey: "AIzaSyAGlltLGv62NuK7A0Af1TUE2SrE2x1pW4A",
        authDomain: "detiwall-pei.firebaseapp.com",
        databaseURL: "https://detiwall-pei-default-rtdb.firebaseio.com",
        projectId: "detiwall-pei",
        storageBucket: "detiwall-pei.appspot.com",
        messagingSenderId: "251921800960",
        appId: "1:251921800960:web:ae6613c0a2c38220041de5",
        measurementId: "G-K70JYWB1R3"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var firebaseRef = firebase.database().ref("localizacao");
        firebaseRef.once("value", function(snapshot){
            var data = snapshot.val();
            var countP1=0;
            var countP2=0;
            var countP3=0;
            var countP4=0;
            var countP5=0;
            var countAp=0;
            for(let i in data){
                var lat = data[i].latitude;
                var long =data[i].longitude
                if ((!isNaN(lat) && !lat.length==0) && (!isNaN(long) && !long.length==0)){
                    if(data[i].Piso==="1"){
                        locs_Piso_1.push({
                            "apName": data[i].name,
                            "id": parseInt(data[i].id,10),
                            "long": long,
                            "lat": lat,
                            "Piso": data[i].Piso,
                            "people": 0
                        })
                        insListInd(data[i].id, data[i].Piso, countP1);
                        countP1++;
                    }
                    else if(data[i].Piso=="2"){
                        locs_Piso_2.push({
                            "apName": data[i].name,
                            "id": data[i].id,
                            "long": long,
                            "lat": lat,
                            "Piso": data[i].Piso,
                            "people": 0
                        })
                        insListInd(data[i].id, data[i].Piso, countP2);
                        countP2++;
                    }
                    else if(data[i].Piso=="3"){
                        locs_Piso_3.push({
                            "id": data[i].id,
                            "apName": data[i].name,
                            "long": long,
                            "lat": lat,
                            "Piso": data[i].Piso,
                            "people": 0
                        })
                        insListInd(data[i].id, data[i].Piso, countP3);
                        countP3++;
                    }
                    else if(data[i].Piso=="4"){
                        locs_Piso_4.push({
                            "apName": data[i].name,
                            "id": data[i].id,
                            "long": long,
                            "lat": lat,
                            "Piso": data[i].Piso,
                            "people": 0
                        })
                        insListInd(data[i].id, data[i].Piso, countP4);
                        countP4++;
                    }
                    else if(data[i].Piso==="5"){
                        locs_Piso_5.push({
                            "apName": data[i].name,
                            "id": data[i].id,
                            "long": long,
                            "lat": lat,
                            "Piso": data[i].Piso,
                            "people": 0
                        })
                        insListInd(data[i].id, data[i].Piso, countP5);
                        countP5++;
                    }
                    else{
                        locs_APS.push({
                            "apName": data[i].name,
                            "id": data[i].id,
                            "long": long,
                            "lat": lat,
                            "Piso": data[i].Piso,
                            "people": 0
                        })
                        insListInd(data[i].id, data[i].Piso, countAp);
                        countAp++;
                    }
                    
                }
            }
        })
        console.log(list_index);
        var firebaseRef2 = firebase.database().ref("data").limitToLast(1);
        firebaseRef2.once("value", function(snapshot){
            snapshot.forEach(function(element){
                var data2 = element.val().accessPoints;
                for(let i in data2){
                    const result = list_index.findIndex(aux => aux.id == data2[i].id);
                    console.log(result);
                    if (result>=0){
                        if (list_index[result].piso == "1") locs_Piso_1[list_index[result].index].people = data2[i].clientCount;
                        else if (list_index[result].piso == "2") locs_Piso_2[list_index[result].index].people = data2[i].clientCount;
                        else if (list_index[result].piso == "3") locs_Piso_3[list_index[result].index].people = data2[i].clientCount;
                        else if (list_index[result].piso == "4") locs_Piso_4[list_index[result].index].people = data2[i].clientCount;
                        else if (list_index[result].piso == "5") locs_Piso_5[list_index[result].index].people = data2[i].clientCount;
                        else locs_APS[list_index[result].index].people = data2[i].clientCount;
                    }
                }
                    
            })
        })
        firebase.analytics();
        
        // Popup template
        const popupOpenspaces = {
            "title": "{title}",
            "content": [{
            "type": "fields",
            "fieldInfos": [
                {
                "fieldName": "AP_NAME",
                "label": "AP",
                "isEditable": true,
                "tooltip": "",
                "visible": true,
                "format": null,
                "stringFieldOption": "text-box"
                },
                {
                "fieldName": "NUM_PES",
                "label": "Numero de pessoas ligadas à rede",
                "isEditable": true,
                "tooltip": "",
                "visible": true,
                "format": null,
                "stringFieldOption": "text-box"
                },
                {
                "fieldName": "NUM_APS",
                "label": "Média de dispositivos ligados à rede na ultima hora",
                "isEditable": true,
                "tooltip": "",
                "visible": true,
                "format": {
                    "places": 2,
                    "digitSeparator": true
                },

                "stringFieldOption": "text-box"
                }
            ]
            }]
        }

        addBTN();

        function insListInd(id, piso, listCount) {
            list_index.push({
                            "id": id,
                            "piso": piso,
                            "index": listCount
                        })
            
        }

        // Change map layer whenever we change the layer on the top right list
        function changeLayer(view, newLayer) {
            
            // change to layer Piso_1
            if (newLayer == "Piso 1"){
                layer = new MapImageLayer({ url: "https://sgt-websig.ua.pt/server/rest/services/Piso_1/MapServer" });
                map = new Map({basemap: "dark-gray-vector", layers: [layer] });

                view = new MapView({
                    container: "viewDiv",
                    map: map,
                    zoom: 16,
                    center: [-8.659132, 40.632902]
                });

                changeList = ["Piso 1",  "Piso 2", "Piso 3", "Piso 4", "Piso 5", "Edifícios"];

                addPoints(locs_Piso_1);
                
            }
            // change to layer Piso_2
            else if (newLayer == "Piso 2"){
                layer = new MapImageLayer({ url: "https://sgt-websig.ua.pt/server/rest/services/Piso_2/MapServer" });
                map = new Map({basemap: "dark-gray-vector", layers: [layer] });

                view = new MapView({
                    container: "viewDiv",
                    map: map,
                    zoom: 16,
                    center: [-8.659132, 40.632902]
                });
                changeList = ["Piso 2",  "Piso 1",  "Piso 2", "Piso 3", "Piso 4", "Piso 5", "Edifícios"];

                addPoints(locs_Piso_2);
            }
            // change to layer Piso_3
            else if (newLayer == "Piso 3"){
                layer = new MapImageLayer({ url: "https://sgt-websig.ua.pt/server/rest/services/Piso_3/MapServer" });
                map = new Map({basemap: "dark-gray-vector", layers: [layer] });

                view = new MapView({
                    container: "viewDiv",
                    map: map,
                    zoom: 16,
                    center: [-8.659132, 40.632902]
                });
                changeList = ["Piso 3",  "Piso 1",  "Piso 2", "Piso 3", "Piso 4", "Piso 5", "Edifícios"];

                addPoints(locs_Piso_3);
            }
            // change to layer Piso_4
            else if (newLayer == "Piso 4"){
                layer = new MapImageLayer({ url: "https://sgt-websig.ua.pt/server/rest/services/Piso_4/MapServer" });
                map = new Map({basemap: "dark-gray-vector", layers: [layer] });

                view = new MapView({
                    container: "viewDiv",
                    map: map,
                    zoom: 16,
                    center: [-8.659132, 40.632902]
                });
                changeList = ["Piso 4",  "Piso 1",  "Piso 2", "Piso 3", "Piso 4", "Piso 5", "Edifícios"];

                addPoints(locs_Piso_4);
            }
            // change to layer Piso_5
            else if (newLayer == "Piso 5"){
                layer = new MapImageLayer({ url: "https://sgt-websig.ua.pt/server/rest/services/Piso_5/MapServer" });
                map = new Map({basemap: "dark-gray-vector", layers: [layer] });

                view = new MapView({
                    container: "viewDiv",
                    map: map,
                    zoom: 16,
                    center: [-8.659132, 40.632902]
                });
                changeList = ["Piso 5",  "Piso 1",  "Piso 2", "Piso 3", "Piso 4", "Piso 5", "Edifícios"];

                addPoints(locs_Piso_5);

            }
            // change to layer Edifícios
            else if (newLayer == "Edifícios"){
                layer = new MapImageLayer({ url: "https://sgt-websig.ua.pt/server/rest/services/Edifícios_UA/MapServer" });
                map = new Map({basemap: "dark-gray-vector", layers: [layer] });

                view = new MapView({
                    container: "viewDiv",
                    map: map,
                    zoom: 16,
                    center: [-8.659132, 40.632902]
                });

                changeList = ["Edifícios",  "Piso 1",  "Piso 2", "Piso 3", "Piso 4", "Piso 5", "Edifícios"];
            
                addPoints(locs_APS);
            
            }
            
            newLayer = changeList[0];
          
            // Add SQL UI
            const select = document.createElement("select","");
            select.setAttribute("class", "esri-widget esri-select");
            select.setAttribute("style", "width: 200px; font-family: 'Avenir Next'; font-size: 1em");
            changeList.forEach(function(query){
                let option = document.createElement("option");
                option.innerHTML = query;
                option.value = query;
                select.appendChild(option);
            });

            view.ui.add(select, "top-right");

            // Listen for changes
            select.addEventListener('change', (event) => {
                newLayer = event.target.value;

                console.log(newLayer);

                changeLayer(view, newLayer);

            });
            
        }

        // Add Points according to an array that contains coordinates
        function addPoints(aps){
            
            for (i = 0; i < aps.length; i++) {
                const graphicsLayer = new GraphicsLayer();
                map.add(graphicsLayer);
                var colorTest = changeColor(aps[i].people);
                
                const point = { //Create a point
                    type: "point",
                    longitude: aps[i].long,
                    latitude: aps[i].lat
                };
                const simpleMarkerSymbol = {
                    type: "simple-marker",
                    color: colorTest, 
                    size: (aps[i].people/2)+4,
                    outline: {
                        color: "black",
                        width: 0.4
                    }
                };
                
                const attributes1 = {
                    title: "Graphic",
                    AP_NAME: aps[i].apName,
                    NUM_PES: aps[i].people,
                    NUM_APS: aps[i].Piso
                }

                const pointGraphic = new Graphic({
                    geometry: point,
                    symbol: simpleMarkerSymbol,

                    attributes : attributes1,
                    popupTemplate: popupOpenspaces
                });
                graphicsLayer.add(pointGraphic);
                   
            }
        }

        // change color of point accordint to the population density in an AP
        function changeColor(demoValue) {
            var color;
            if (demoValue == 0){
                color = "89CFF0"
            }
            else if (demoValue <= 4) {
                color = "green"
            }
            else if(demoValue <= 6){
                color = "#fbaf52"
            }
            else if(demoValue <= 8){
                color = "#f6711f"
            }
            else if (demoValue <= 10){
                color = "#c33910"
            }
            else{
                color = "#910000"
            }
            return color;
        }
      
        // add the button to change map layer
        function addBTN() {
          
          
            // SQL query array
            const changeList = ["Escolha um Piso", "Piso 1",  "Piso 2", "Piso 3", "Piso 4", "Piso 5", "Edifícios"];
            let newLayer = changeList[0];
          
            // Add SQL UI
            const select = document.createElement("select","");
            select.setAttribute("class", "esri-widget esri-select");
            select.setAttribute("style", "width: 200px; font-family: 'Avenir Next'; font-size: 1em");
            changeList.forEach(function(query){
                let option = document.createElement("option");
                option.innerHTML = query;
                option.value = query;
                select.appendChild(option);
            });

            view.ui.add(select, "top-right");

            // Listen for changes
            select.addEventListener('change', (event) => {
                newLayer = event.target.value;

                console.log(newLayer);

                changeLayer(view, newLayer);

            });
        }

        });
    </script>
    </head>
    <body>
    <div id="viewDiv" class="esri-view esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge esri-view-orientation-landscape">
        <div class="esri-view-root">
            <div class="esri-view-surface esri-view-surface--inset-outline esri-view-surface--touch-none" role="application" tabindex="0">
                <canvas style="width: 1365px; height: 882px; display: block;" width="1365" height="882"></canvas>
            </div>
            <div class="esri-overlay-surface">
                <div style="visibility: hidden;">
                </div>
            </div>
            
        </div>
        <div class="esri-view-user-storage">
        </div>
    </div>
    </body>
</html>
